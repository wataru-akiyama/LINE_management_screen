# MOISH LINE管理画面 要件定義書 ver2

## 概要

LINE管理画面に以下の機能を追加し、**ノーコードで運用できる管理システム**を構築する。

| 機能 | 概要 |
|------|------|
| 診断・プロフィール収集ビルダー | GUIで診断フローを作成・編集 |
| アンケート機能 | アンケート作成・配信・集計 |
| リッチメニュー管理 | 画像アップロード・アクション設定・プラン別切替 |

---

## 1. 診断・プロフィール収集ビルダー

### 1.1 機能概要

現在コードで実装している診断フローを、**管理画面から直感的に作成・編集**できるようにする。

### 1.2 画面構成

```
サイドバー: 診断管理
├── 診断一覧（作成済みの診断リスト）
├── 新規作成
└── 設定（共通設定）
```

### 1.3 診断ビルダーUI

#### 質問タイプ

| タイプ | 説明 | 例 |
|--------|------|-----|
| **単一選択** | 1つだけ選択 | はい/いいえ/わからない |
| **複数選択** | 複数選択可能 | 興味のある大学を全て選択 |
| **テキスト入力** | 自由入力 | お名前を入力 |
| **選択肢ボタン** | カスタム選択肢 | 高1/高2/高3/保護者/指導者 |
| **日付入力** | 日付ピッカー | 生年月日 |
| **地域選択** | 地域→都道府県の2段階 | 関東→東京都 |

#### スコアリング設定

- 各回答に対してタイプ別スコアを設定可能
- スコア計算ロジック：合計スコアが最大のタイプを結果として表示
- 結果タイプは**管理画面から追加・編集可能**

```
例：
Q1「将来サッカーを仕事にしたい」
├── はい     → プロ志向型 +2.5, サポート型 +2.0
├── いいえ   → エンジョイ型 +1.0, 経験重視型 +0.5
└── わからない → チャレンジ型 +0.5, チーム成長型 +0.5
```

#### 条件分岐

- 回答内容によって次の質問をスキップ/変更可能
- 例：「保護者」を選択した場合、選手向け質問をスキップ

### 1.4 データ構造（スプレッドシート）

**診断マスタシート (`diagnosis_templates`)**

| 列 | 説明 |
|----|------|
| id | 診断ID |
| name | 診断名 |
| description | 説明 |
| status | active/draft/archived |
| createdAt | 作成日時 |
| updatedAt | 更新日時 |

**質問シート (`diagnosis_questions`)**

| 列 | 説明 |
|----|------|
| diagnosisId | 紐づく診断ID |
| questionId | 質問ID |
| order | 表示順 |
| type | 質問タイプ |
| text | 質問文 |
| options | 選択肢（JSON） |
| scores | スコア設定（JSON） |
| condition | 条件分岐ルール（JSON） |

**結果タイプシート (`diagnosis_result_types`)**

| 列 | 説明 |
|----|------|
| diagnosisId | 紐づく診断ID |
| typeId | タイプID (A, B, C...) |
| name | タイプ名 |
| description | 説明文 |
| icon | アイコン絵文字 |

---

## 2. アンケート機能

### 2.1 機能概要

ユーザーにアンケートを配信し、回答を収集・集計する。

### 2.2 画面構成

```
サイドバー: アンケート
├── アンケート一覧
├── 新規作成
├── 回答一覧
└── 集計・グラフ
```

### 2.3 アンケートビルダーUI

#### 質問タイプ

| タイプ | 説明 |
|--------|------|
| 単一選択 | ラジオボタン形式 |
| 複数選択 | チェックボックス形式 |
| テキスト（短文） | 1行入力 |
| テキスト（長文） | 複数行入力 |
| 評価スケール | 1〜5などの段階評価 |
| NPS | 0〜10の推奨度 |

### 2.4 配信設定

- **即時配信**: 作成後すぐに配信
- **予約配信**: 日時を指定して配信
- **セグメント配信**: 条件に合うユーザーのみに配信

### 2.5 集計・グラフ機能

- 回答のリアルタイム集計
- グラフ表示（円グラフ、棒グラフ）
- CSV/Excelエクスポート

### 2.6 データ構造

**アンケートマスタ (`surveys`)**

| 列 | 説明 |
|----|------|
| id | アンケートID |
| title | タイトル |
| description | 説明 |
| status | draft/active/closed |
| createdAt | 作成日時 |

**アンケート質問 (`survey_questions`)**

| 列 | 説明 |
|----|------|
| surveyId | 紐づくアンケートID |
| questionId | 質問ID |
| order | 表示順 |
| type | 質問タイプ |
| text | 質問文 |
| options | 選択肢（JSON） |
| required | 必須かどうか |

**アンケート回答 (`survey_responses`)**

| 列 | 説明 |
|----|------|
| responseId | 回答ID |
| surveyId | アンケートID |
| userId | 回答ユーザーID |
| answers | 回答内容（JSON） |
| submittedAt | 回答日時 |

---

## 3. リッチメニュー管理

### 3.1 機能概要

リッチメニューを**管理画面から作成・編集**し、プラン別に切り替えられるようにする。

### 3.2 画面構成

```
サイドバー: リッチメニュー
├── メニュー一覧
├── 新規作成
└── プラン設定
```

### 3.3 リッチメニュービルダーUI

#### レイアウトテンプレート

```
テンプレートA（6分割）     テンプレートB（4分割）
┌───┬───┬───┐           ┌─────────┬─────────┐
│ 1 │ 2 │ 3 │           │    1    │    2    │
├───┼───┼───┤           ├─────────┼─────────┤
│ 4 │ 5 │ 6 │           │    3    │    4    │
└───┴───┴───┘           └─────────┴─────────┘

テンプレートC（カスタム）
→ エリアを自由に設定可能
```

#### エリア設定

各エリアに以下を設定：
- **ラベル**: アクション名（内部管理用）
- **アクションタイプ**:
  - URL遷移 → URLを入力
  - テキスト送信 → 送信テキストを入力
  - Postback → データを入力

#### 画像アップロード

- 対応形式: PNG, JPEG
- 推奨サイズ: 2500×1686px または 2500×843px
- ドラッグ&ドロップでアップロード

### 3.4 プラン別切替

| 設定項目 | 説明 |
|----------|------|
| プラン名 | FREE, BASIC, ... |
| 適用メニュー | 作成したメニューから選択 |
| 自動切替 | ユーザーのプラン変更時に自動適用 |

### 3.5 データ構造

**リッチメニューマスタ (`richmenus`)**

| 列 | 説明 |
|----|------|
| id | メニューID |
| name | メニュー名 |
| lineRichMenuId | LINE APIのID |
| imageFileId | Google DriveファイルID |
| layout | レイアウト設定（JSON） |
| areas | エリア設定（JSON） |
| status | active/draft |
| createdAt | 作成日時 |

**プラン別設定 (`richmenu_plan_mapping`)**

| 列 | 説明 |
|----|------|
| plan | プラン名 |
| richMenuId | 適用するメニューID |

---

## 4. 技術スタック

| レイヤー | 技術 |
|----------|------|
| フロントエンド | React + TypeScript + Tailwind CSS |
| バックエンド | Google Apps Script |
| データベース | Google Spreadsheet |
| 画像ストレージ | Google Drive |
| 外部API | LINE Messaging API |

---

## 5. 画面一覧（追加分）

| パス | 画面名 | 説明 |
|------|--------|------|
| `/diagnosis` | 診断管理 | 診断一覧・作成・編集 |
| `/diagnosis/new` | 診断作成 | 新規診断ビルダー |
| `/diagnosis/:id` | 診断編集 | 既存診断の編集 |
| `/surveys` | アンケート管理 | アンケート一覧 |
| `/surveys/new` | アンケート作成 | 新規アンケート作成 |
| `/surveys/:id` | アンケート編集 | 既存アンケートの編集 |
| `/surveys/:id/results` | 回答結果 | 集計・グラフ表示 |
| `/richmenus` | リッチメニュー管理 | メニュー一覧 |
| `/richmenus/new` | リッチメニュー作成 | 新規メニュー作成 |
| `/richmenus/:id` | リッチメニュー編集 | 既存メニューの編集 |
| `/richmenus/plans` | プラン設定 | プラン別メニュー設定 |

---

## 6. 実装優先度

| 優先度 | 機能 | 理由 |
|--------|------|------|
| 🔴 高 | リッチメニュー管理 | 既存コードあり、早期に移行可能 |
| 🟡 中 | 診断ビルダー | 既存ロジックをGUI化 |
| 🟢 低 | アンケート機能 | 新規機能のため後から追加 |

---

## 7. 参考UI

- **LINE公式アカウント管理画面**: リッチメニュー作成UI
- **Lステップ**: 診断・アンケートビルダー、セグメント配信

---

## 8. 次のステップ

1. 要件定義書の確認・承認
2. リッチメニュー管理画面から実装開始
3. 診断ビルダーの実装
4. アンケート機能の実装
